name: Upload

on:
  workflow_run:
    workflows: [Rust]
    types:
      - completed

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  upload:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
    - uses: actions/checkout@v3
    - name: 'Download artifact'
      uses: actions/github-script@v6
      with:
        script: |
          var artifacts = await github.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{github.event.workflow_run.id }},
          });
          var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
            return artifact.name == "visual-snapshots"
          })[0];
          var download = await github.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
          });
          var fs = require('fs');
          fs.writeFileSync('${{github.workspace}}/visual-snapshots.zip', Buffer.from(download.data));
    - name: Unzip artifact
      run: unzip visual-snapshots.zip
    - name: Display structure of downloaded files
      run: ls -R
    # - name: Upload to B2
    #   uses: shallwefootball/s3-upload-action@master
    #   id: B2
    #   with:
    #     aws_key_id: ${{ secrets.AWS_KEY_ID }}
    #     aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY}}
    #     aws_bucket: ${{ vars.AWS_BUCKET }}
    #     endpoint: ${{ vars.AWS_ENDPOINT }}
    #     source_dir: "visual-snapshots"
    #     destination_dir: "30-days/${{ github.repository }}/${{ github.run_id }}"
    # - name: Generate snapshots comment
    #   run: ./bin/snapshots-comment '${{steps.B2.outputs.object_locations}}'
    # - uses: jwalton/gh-find-current-pr@v1
    #   id: finder
    # - uses: marocchino/sticky-pull-request-comment@v2
    #   with:
    #     number: ${{ steps.finder.outputs.pr }}
    #     header: "Visual Snapshots"
    #     path: "./visual-snapshots.tmp"
    # - name: Job summary (visuals)
    #   run: cat visual-snapshots.tmp > $GITHUB_STEP_SUMMARY
